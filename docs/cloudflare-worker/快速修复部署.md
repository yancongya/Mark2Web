# Cloudflare Worker 快速修复部署

## 当前问题

1. **405 错误** - Worker 不支持 GET 请求（模型获取需要 GET）
2. **生成卡住** - Worker 尝试解析流式数据为 JSON，导致崩溃
3. **缺少模型端点** - Worker 只处理 `/chat/completions`

## 解决方案

使用 `worker_fixed.js` 替换现有 Worker 代码。

## 快速部署步骤

### 方法 1: Cloudflare Dashboard (推荐)

1. 打开 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 **Workers & Pages** → **Your Worker**
3. 点击 **Quick Edit**
4. 删除旧代码，粘贴 `worker_fixed.js` 的内容
5. 点击 **Save and Deploy**

### 方法 2: Wrangler CLI

```bash
# 1. 保存新代码到本地
cp worker_fixed.js worker.js

# 2. 部署
wrangler deploy

# 3. 验证
curl -X GET https://your-worker.workers.dev/models \
  -H "Authorization: Bearer YOUR_API_KEY"
```

## 验证修复

### 测试模型获取
```bash
curl -X GET https://your-worker.workers.dev/models \
  -H "Authorization: Bearer sk-xxx"
```

应该返回：
```json
{
  "object": "list",
  "data": [
    {"id": "mimo-v2-flash", ...}
  ]
}
```

### 测试流式生成
```bash
curl -X POST https://your-worker.workers.dev/chat/completions \
  -H "Authorization: Bearer sk-xxx" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "mimo-v2-flash",
    "messages": [{"role": "user", "content": "Hello"}],
    "stream": true
  }'
```

应该返回流式响应（以 `data:` 开头）。

## 在 Mark2Web 中配置

1. 打开 Settings → Providers
2. 找到 Xiaomi Mimo
3. 填入 Worker URL（例如：`https://your-worker.workers.dev`）
4. 填入 API Key
5. 点击 "Fetch Models" - 应该显示 `mimo-v2-flash`
6. 点击 "Test Connection" - 应该显示成功
7. 上传 Markdown 并生成 - 应该正常工作

## 关键改进

| 功能 | 旧 Worker | 新 Worker |
|------|-----------|-----------|
| POST /chat/completions | ✅ | ✅ |
| GET /models | ❌ | ✅ |
| Streaming support | ❌ | ✅ |
| GET requests | ❌ | ✅ |
| Error handling | 基础 | 完整 |

## 如果还有问题

### 检查 Worker 日志
```bash
wrangler tail
```

### 测试你的配置
```javascript
// 在浏览器控制台测试
fetch('https://your-worker.workers.dev/models', {
  method: 'GET',
  headers: { 'Authorization': 'Bearer sk-xxx' }
}).then(r => r.json()).then(console.log)
```

### 常见问题

**Q: 仍然看到 405 错误？**
A: Worker 没有更新成功，确保使用了 `worker_fixed.js`

**Q: 模型列表为空？**
A: 检查 API Key 是否正确，查看 Worker 日志

**Q: 生成仍然卡住？**
A: 确保 Worker 正确处理 streaming，检查 `stream: true` 是否被正确转发

## 下一步

更新 Worker 后，Mark2Web 应该能：
- ✅ 获取真实模型列表
- ✅ 正常生成网页内容
- ✅ 支持流式响应

如果问题持续，请提供：
1. Worker 日志
2. 浏览器网络请求截图
3. Mark2Web 配置截图
