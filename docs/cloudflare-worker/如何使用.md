# 🎯 如何使用 Cloudflare Worker 解决小米 Mimo CORS 问题

## 📖 本文档适合谁？

- ✅ 想在纯前端部署的 Mark2Web 中使用小米 Mimo
- ✅ 不想配置复杂后端服务器
- ✅ 需要 3-5 分钟快速解决方案

---

## 🚀 **最快速开始（3分钟）**

### **第1步：部署 Worker（2分钟）**

**选择一种方式：**

#### **方式 A: Cloudflare 网页部署（最简单）**
```
1. 打开 https://dash.cloudflare.com
2. 登录 → Workers & Pages → Create Worker
3. 名称: xiaomimimo-proxy
4. 复制 worker.js 的代码 → 粘贴 → Deploy
5. 复制生成的 URL
```

#### **方式 B: 命令行部署**
```bash
# Windows
deploy.bat

# Linux/Mac
./deploy.sh
```

---

### **第2步：配置 Mark2Web（1分钟）**

**设置 → 模型服务商 → 小米 Mimo**

```
Proxy URL: [粘贴第1步获得的 URL]
API Key:   [你的小米 Mimo Key]
```

---

### **第3步：测试（1分钟）**

在 Mark2Web 中点击 **测试连接** → ✅ 成功！

---

## 📦 **文件清单**

你下载的文件夹包含：

| 文件 | 用途 | 需要修改吗？ |
|------|------|-------------|
| **worker.js** | Worker 主代码 | ❌ 不需要 |
| **wrangler.toml** | 部署配置 | ❌ 不需要 |
| **deploy.bat/deploy.sh** | 一键部署 | ❌ 不需要 |
| **test.js** | 测试脚本 | ✅ 需要填 URL 和 Key |
| **README.md** | 完整文档 | 参考阅读 |
| **快速部署指南.md** | 步骤详解 | 参考阅读 |
| **部署清单.md** | 检查清单 | 跟踪进度 |
| **开始部署.txt** | 最简指南 | 快速参考 |
| **项目总结.md** | 项目概览 | 了解整体 |

---

## 🔧 **核心文件详解**

### **worker.js（唯一需要部署的文件）**

这个文件的作用：
- 接收来自 Mark2Web 的请求
- 转发到小米 Mimo API
- 返回结果给 Mark2Web
- **自动处理 CORS 问题**

**代码结构**：
```javascript
addEventListener('fetch', event => {
  event.respondWith(handleRequest(event.request))
})

async function handleRequest(request) {
  // 1. 处理 CORS 预检
  // 2. 验证请求
  // 3. 转发到小米 Mimo
  // 4. 返回结果
}
```

---

## 🎯 **Mark2Web 配置详解**

### **完整配置示例**

```typescript
{
  providerId: 'xiaomi-mimo',      // 唯一标识
  type: 'openai',                 // 使用 OpenAI 兼容格式
  label: '小米 Mimo',             // 显示名称
  baseUrl: 'https://api.xiaomimimo.com',  // 小米 API 地址
  proxyUrl: 'https://your-worker.workers.dev',  // ← 你的 Worker URL
  apiKey: 'sk-xxx...',            // 你的 API Key
  modelId: 'mimo-v2-flash'        // 模型名称
}
```

### **字段说明**

| 字段 | 说明 | 示例 |
|------|------|------|
| `providerId` | 内部标识 | `xiaomi-mimo` |
| `type` | API 类型 | `openai`（兼容格式） |
| `label` | 显示名称 | `小米 Mimo` |
| `baseUrl` | 小米 API 地址 | `https://api.xiaomimimo.com` |
| `proxyUrl` | **你的 Worker URL** | `https://xxx.workers.dev` |
| `apiKey` | 小米 API Key | `sk-xxx...` |
| `modelId` | 模型名称 | `mimo-v2-flash` |

---

## ✅ **验证清单**

部署完成后，检查：

- [ ] Worker 已部署（不是仅保存）
- [ ] 获得了 Worker URL（格式：`https://xxx.workers.dev`）
- [ ] 在 Mark2Web 中填写了 Proxy URL
- [ ] 填写了正确的 API Key
- [ ] 点击测试连接 → 显示 ✅ 成功
- [ ] 尝试生成代码 → 正常工作

---

## 🔍 **常见问题**

### **Q: 部署后访问 Worker URL 显示错误？**
A: 正常！Worker 只处理 POST 请求。用 curl 或 Mark2Web 测试。

### **Q: 测试连接失败？**
A: 检查：
1. Proxy URL 是否正确
2. API Key 是否有效
3. Worker 是否已部署

### **Q: 想删除或修改 Worker？**
A: Cloudflare Dashboard → Workers & Pages → 选择 Worker → Settings

### **Q: 费用是多少？**
A: **完全免费**（100,000 请求/天）

---

## 📊 **工作流程图**

```
┌─────────────────┐
│  Mark2Web 前端  │
│  (浏览器)       │
└────────┬────────┘
         │ 发送请求
         ↓
┌─────────────────────────┐
│  Cloudflare Worker      │
│  (你的代理)             │
│  - 接收请求             │
│  - 添加 CORS 头         │
│  - 转发到小米 API       │
└────────┬────────────────┘
         │
         ↓
┌─────────────────┐
│  小米 Mimo API  │
└────────┬────────┘
         │
         ↓
┌─────────────────┐
│  返回结果       │
└─────────────────┘
```

---

## 🎓 **技术原理**

### **为什么需要 Worker？**

```
浏览器 → 小米 API ❌ (CORS 错误)

浏览器 → Worker → 小米 API ✅ (CORS 解决)
```

### **Worker 做了什么？**

1. **接收请求**：从 Mark2Web 获取数据
2. **添加 CORS 头**：`Access-Control-Allow-Origin: *`
3. **转发请求**：发送到小米 Mimo API
4. **返回响应**：将结果送回 Mark2Web

---

## 🚀 **现在就开始！**

### **快速路径**

1. **打开 Cloudflare**: https://dash.cloudflare.com
2. **创建 Worker**: 粘贴 `worker.js` 代码
3. **部署**: 点击 Deploy
4. **复制 URL**: 获得 `https://xxx.workers.dev`
5. **配置 Mark2Web**: 填入 URL 和 API Key
6. **测试**: 点击测试连接

### **需要帮助？**

- **详细步骤**: 查看 `快速部署指南.md`
- **检查清单**: 查看 `部署清单.md`
- **完整文档**: 查看 `README.md`

---

## 🎉 **完成后的效果**

✅ **纯前端部署** - 无需后端服务器
✅ **浏览器直接访问** - 小米 Mimo API
✅ **全球加速** - Cloudflare CDN
✅ **完全免费** - 个人使用无限制

---

**准备好了吗？现在就开始部署吧！** 🚀

有任何问题，请查看其他文档文件。
